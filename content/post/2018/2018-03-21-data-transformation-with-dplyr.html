---
title: 使用dplyr进行数据转换
author: 王诗翔
date: '2018-03-21'
slug: data-transformation-with-dplyr
categories:
  - R
  - 数据分析
tags:
  - learn
  - notebook
---


<div id="TOC">
<ul>
<li><a>准备</a><ul>
<li><a href="#nycflights13">nycflights13</a></li>
<li><a href="#dplyr">dplyr基础</a></li>
</ul></li>
<li><a href="#filter">使用filter()过滤行</a><ul>
<li><a>比较</a></li>
<li><a>逻辑操作符</a></li>
</ul></li>
</ul>
</div>

<p>该部分学习内容来自《R for Data Science》。</p>
<p>在对数据进行可视化之前我们往往需要进行数据转换以得到可视化所需要的数据内容与格式。这里我们使用<code>dplyr</code>包操作2013年纽约市的航班起飞数据集（2013）。</p>
<div class="section level2">
<h2>准备</h2>
<p>这部分我们聚焦于如何使用<code>dplyr</code>包，除<code>ggplot2</code>的另一个<strong>tidyverse</strong>核心成员。我们将使用<code>nyclights13</code>数据包解释关键的概念并使用<code>ggplot2</code>帮助理解数据。</p>
<pre class="r"><code># 导入包
library(nycflights13) # 请确保在使用前已经安装好这些包
library(tidyverse)
## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr
## Conflicts with tidy packages ----------------------------------------------
## filter(): dplyr, stats
## lag():    dplyr, stats</code></pre>
<p>注意一下你导入<code>tidyverse</code>包时给出的冲突信息（Conflicts），它告诉你<strong>dplyr</strong>覆盖了R基础包中的函数。<strong>如果你想要在载入<code>tidyverse</code>包后仍然使用这些函数，你需要使用函数的全名<code>stats::filter()</code>和<code>stats::lag()</code>进行调用。</strong></p>
<div id="nycflights13" class="section level3">
<h3>nycflights13</h3>
<p>我们将使用<code>nycflights13::flights</code>来探索<code>dplyr</code>包基本的数据操作<strong>动词</strong>。该数据集包含2013年336,776次航班起飞数据，来自美国交通统计局。</p>
<pre class="r"><code>flights
## # A tibble: 336,776 x 19
##     year month   day dep_t~ sched_~ dep_d~ arr_~ sched~ arr_d~ carr~ flig~
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1  2013     1     1    517     515   2.00   830    819  11.0  UA     1545
##  2  2013     1     1    533     529   4.00   850    830  20.0  UA     1714
##  3  2013     1     1    542     540   2.00   923    850  33.0  AA     1141
##  4  2013     1     1    544     545  -1.00  1004   1022 -18.0  B6      725
##  5  2013     1     1    554     600  -6.00   812    837 -25.0  DL      461
##  6  2013     1     1    554     558  -4.00   740    728  12.0  UA     1696
##  7  2013     1     1    555     600  -5.00   913    854  19.0  B6      507
##  8  2013     1     1    557     600  -3.00   709    723 -14.0  EV     5708
##  9  2013     1     1    557     600  -3.00   838    846 - 8.00 B6       79
## 10  2013     1     1    558     600  -2.00   753    745   8.00 AA      301
## # ... with 336,766 more rows, and 8 more variables: tailnum &lt;chr&gt;, origin
## #   &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute
## #   &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<p>与基本包显示的普通数据集输出不同，这里适配地显示了在一个屏幕前几行和所有的列（我们可以使用<code>View(flights）</code>在Rstudio中查看数据集的所有信息。输出显示不同的原因是这个数据集是一个<em>Tibble</em>。<strong>Tibbles</strong>都是数据框<code>data.frame</code>，但经过改良以便于更好（在<code>tidyverse</code>生态中）工作。现在我们不必纠结于这些差异，在后续内容中我们会进行学习。</p>
<p>你可能已经注意到每个列名下面有<strong>三到四个字母的缩写</strong>。它们描述了每个变量的类型：</p>
<ul>
<li><code>int</code>代表整数</li>
<li><code>dbl</code>代表浮点数或者实数</li>
<li><code>chr</code>代表字符向量或者字符串</li>
<li><code>dttm</code>代表日期-时间</li>
</ul>
<p>还有其他三种数据类型在本部分不会使用到，但后续我们会接触：</p>
<ul>
<li><code>lgl</code>代表逻辑向量，只含<code>TRUE</code>和<code>FALSE</code></li>
<li><code>fctr</code>代表因子，R用它来代表含固定可能值的分类变量</li>
<li><code>date</code>代表日期</li>
</ul>
</div>
<div id="dplyr" class="section level3">
<h3>dplyr基础</h3>
<p>这部分我们学习5个关键的<code>dplyr</code>函数，它可以让我们解决遇到的大部分数据操作问题：</p>
<ul>
<li>根据值选择观察（记录），<code>filter()</code></li>
<li>对行重新排序，<code>arrange()</code></li>
<li>根据名字选择变量，<code>select()</code></li>
<li>根据已知的变量创建新的变量，<code>mutate()</code></li>
<li>将许多值塌缩为单个描述性汇总，<code>summarize()</code></li>
</ul>
<p>这些函数都可以通过<code>group_by()</code>衔接起来，该函数改变上述每个函数的作用域，<strong>从操作整个数据集到按组与组操作</strong>。这六个函数提供了数据操作语言的动词。</p>
<p>所有的动词工作都非常相似：</p>
<ol style="list-style-type: decimal">
<li>第一个参数都是数据框</li>
<li>随后的参数描述了使用变量名（不加引号）对数据框做什么</li>
<li>结果是一个新的数据框</li>
</ol>
<p>这些属性一起便利地将多个简单步骤串联起来得到一个复杂的操作（结果）。让我们实际来看看这些动词是怎么工作的。</p>
</div>
</div>
<div id="filter" class="section level2">
<h2>使用filter()过滤行</h2>
<p><code>filter()</code>允许我们根据观测值来对数据集取子集。第一个参数是数据框的名字，第二和随后的参数是用于过滤数据框的表达式。</p>
<p>比如，我们可以选择所有一月一号的航班：</p>
<pre class="r"><code>filter(flights, month == 1, day == 1)
## # A tibble: 842 x 19
##     year month   day dep_t~ sched_~ dep_d~ arr_~ sched~ arr_d~ carr~ flig~
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1  2013     1     1    517     515   2.00   830    819  11.0  UA     1545
##  2  2013     1     1    533     529   4.00   850    830  20.0  UA     1714
##  3  2013     1     1    542     540   2.00   923    850  33.0  AA     1141
##  4  2013     1     1    544     545  -1.00  1004   1022 -18.0  B6      725
##  5  2013     1     1    554     600  -6.00   812    837 -25.0  DL      461
##  6  2013     1     1    554     558  -4.00   740    728  12.0  UA     1696
##  7  2013     1     1    555     600  -5.00   913    854  19.0  B6      507
##  8  2013     1     1    557     600  -3.00   709    723 -14.0  EV     5708
##  9  2013     1     1    557     600  -3.00   838    846 - 8.00 B6       79
## 10  2013     1     1    558     600  -2.00   753    745   8.00 AA      301
## # ... with 832 more rows, and 8 more variables: tailnum &lt;chr&gt;, origin
## #   &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute
## #   &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<p>这一行代码<code>dplyr</code>执行了过滤操作并返回了一个新的数据框。<strong>dplyr从不修改输入数据，所以如果你想要保存数据，必须使用<code>&lt;-</code>进行赋值</strong>：</p>
<pre class="r"><code>jan1 &lt;- filter(flights, month == 1, day == 1)</code></pre>
<p>R要么输出结果，要么将结果保存到一个变量。如果我们想要同时做到这一点，你可以把赋值放在括号里：</p>
<pre class="r"><code>(dec25 &lt;- filter(flights, month == 12, day == 25))
## # A tibble: 719 x 19
##     year month   day dep_t~ sched_~ dep_d~ arr_~ sched~ arr_d~ carr~ flig~
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1  2013    12    25    456     500  -4.00   649    651 - 2.00 US     1895
##  2  2013    12    25    524     515   9.00   805    814 - 9.00 UA     1016
##  3  2013    12    25    542     540   2.00   832    850 -18.0  AA     2243
##  4  2013    12    25    546     550  -4.00  1022   1027 - 5.00 B6      939
##  5  2013    12    25    556     600  -4.00   730    745 -15.0  AA      301
##  6  2013    12    25    557     600  -3.00   743    752 - 9.00 DL      731
##  7  2013    12    25    557     600  -3.00   818    831 -13.0  DL      904
##  8  2013    12    25    559     600  -1.00   855    856 - 1.00 B6      371
##  9  2013    12    25    559     600  -1.00   849    855 - 6.00 B6      605
## 10  2013    12    25    600     600   0      850    846   4.00 B6      583
## # ... with 709 more rows, and 8 more variables: tailnum &lt;chr&gt;, origin
## #   &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute
## #   &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<div class="section level3">
<h3>比较</h3>
<p>想要有效地过滤，你必须知道怎么利用比较操作符来选择观测值。R提供了标准的比较符：<code>&gt;</code>,<code>&gt;=</code>,<code>&lt;=</code>,<code>!=</code>和<code>==</code>。</p>
<p>如果你是初学R，一个常见的错误是用<code>=</code>而不是<code>==</code>来检测相等。如果这种情况发生了，你会收到报错信息：</p>
<pre class="r"><code>filter(flights, month = 1)
#&gt; Error: `month` (`month = 1`) must not be named, do you need `==`?</code></pre>
<p>另一个你在使用<code>==</code>时可能遭遇的常见问题是<strong>浮点数</strong>。下面的结果可能会让你惊掉大牙：</p>
<pre class="r"><code>sqrt(2) ^ 2 == 2
## [1] FALSE
1/49 * 49 == 1
## [1] FALSE</code></pre>
</div>
<div class="section level3">
<h3>逻辑操作符</h3>
<p><code>&amp;</code>是与，<code>|</code>是或，<code>!</code>是非。</p>
<p>下面代码找到在十一月或十二月起飞的所有航班：</p>
<pre class="r"><code>filter(flights, month == 11 | month == 12)
## # A tibble: 55,403 x 19
##     year month   day dep_t~ sched~ dep_del~ arr_~ sche~ arr_d~ carr~ flig~
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt;  &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1  2013    11     1      5   2359     6.00   352   345   7.00 B6      745
##  2  2013    11     1     35   2250   105      123  2356  87.0  B6     1816
##  3  2013    11     1    455    500  -  5.00   641   651 -10.0  US     1895
##  4  2013    11     1    539    545  -  6.00   856   827  29.0  UA     1714
##  5  2013    11     1    542    545  -  3.00   831   855 -24.0  AA     2243
##  6  2013    11     1    549    600  - 11.0    912   923 -11.0  UA      303
##  7  2013    11     1    550    600  - 10.0    705   659   6.00 US     2167
##  8  2013    11     1    554    600  -  6.00   659   701 - 2.00 US     2134
##  9  2013    11     1    554    600  -  6.00   826   827 - 1.00 DL      563
## 10  2013    11     1    554    600  -  6.00   749   751 - 2.00 DL      731
## # ... with 55,393 more rows, and 8 more variables: tailnum &lt;chr&gt;, origin
## #   &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute
## #   &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<p><strong>注意</strong>，你不能写成<code>filter(flights, month == 11 | 12)</code>，（虽然语义上讲的通）对于R而言，它会先计算<code>11|12</code>得到<code>1</code>，然后计算<code>month == 1</code>，这就不是我们需要的了！</p>
</div>
</div>
